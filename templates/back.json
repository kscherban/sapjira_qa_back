{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "dbUsername": {
            "type": "string",
            "metadata": {
                "description": "Database username"
            }
        },
        "dbPassword": {
            "type": "string",
            "metadata": {
                "description": "Database password"
            }
        },
        "adminUsername": {
            "type": "string"
          },
          "adminPassword": {
            "type": "string"
          }
    },
    "variables": {
        "storageName": "datastorage",
        "namespace": "jira",
        "sql": {
            "server": {
                "name": "[concat(variables('namespace'), 'sqlserver', uniqueString(resourceGroup().id))]",
                "username": "[parameters('dbUsername')]",
                "password": "[parameters('dbPassword')]"
            },
            "database": {
                "name": "[concat('jira', 'sqldatabase')]",
                "edition": "Premium",
                "collation": "SQL_Latin1_General_CP437_CI_AI",
                "maxSizeBytes": "107374182400",
                "schema": "jiraschema"
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "name": "myVnet",
            "apiVersion": "2016-12-01",
            "location": "[resourceGroup().location]",
            "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.0.0.0/16"
                  ]
                },
                "subnets": [
                  {
                    "name": "mySubnet",
                    "properties": {
                      "addressPrefix": "10.0.0.0/16"
                    }
                  },
                  {
                    "name": "subnetappgw",
                    "properties": {
                      "addressPrefix": "10.1.0.0/16"
                    }
                  }
                ]
              }
            },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[concat(variables('storagename'), uniqueString(resourceGroup().id))]",
            "apiVersion": "2015-06-15",
            "location": "West Europe",
            "properties": {
              "accountType": "Standard_LRS"
            }
          },
  {
    "name": "[concat(variables('sql').server.name, uniqueString(resourceGroup().id))]",
    "type": "Microsoft.Sql/servers",
    "apiVersion": "2015-05-01-preview",
    "location": "[resourceGroup().location]",
    "identity": {
      "type": "SystemAssigned"
    },
    "properties": {
      "administratorLogin": "[variables('sql').server.username]",
      "administratorLoginPassword": "[variables('sql').server.password]",
      "version": "12.0"
    },
    "resources": [
    {
        "type": "databases",
        "name": "[variables('sql').database.name]",
        "apiVersion": "2015-05-01-preview",
        "location": "[resourceGroup().location]",
        "properties": {
            "edition": "[variables('sql').database.edition]",
            "collation": "[variables('sql').database.collation]",
            "maxSizeBytes": "[variables('sql').database.maxSizeBytes]",
            "requestedServiceObjectiveName": "Premium"
        },
        "dependsOn": [
            "[resourceId('Microsoft.Sql/servers/', concat(variables('sql').server.name, uniqueString(resourceGroup().id)))]"
        ]
    }
    ]
  },
  {
    "type": "Microsoft.Compute/virtualMachineScaleSets",
        "name": "myscaleset",
        "location": "[resourceGroup().location]",
        "apiVersion": "2017-03-30",
        "dependsOn": [
            "Microsoft.Network/virtualNetworks/myVnet"
        ],
        "sku": {
          "name": "Standard_A1",
          "tier": "Standard",
          "capacity": 6
        },
        "properties": {
          "upgradePolicy": {
            "mode": "Manual"
          },
          "virtualMachineProfile": {
            "storageProfile": {
              "imageReference": {
                "publisher": "Canonical",
                "offer": "UbuntuServer",
                "sku": "16.04-LTS",
                "version": "latest"       
              }
            },
            "osProfile": {
              "computerNamePrefix": "vm",
              "adminUsername": "[parameters('adminUsername')]",
              "adminPassword": "[parameters('adminPassword')]"
            },
            "networkProfile": {
                "networkInterfaceConfigurations": [
                    {
                      "name": "myNic",
                      "properties": {
                        "primary": true,
                        "ipConfigurations": [
                          {
                            "name": "myIpConfig",
                            "properties": {
                              "subnet": {
                                "id": "[concat(resourceId('Microsoft.Network/virtualNetworks', 'myVnet'), '/subnets/mySubnet')]"
                              }
                            }
                          }
                        ]
                      }
                    }
                  ]
            }
          }
        }
      },
      {
        "apiVersion": "2017-05-10",
        "name": "vm",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "TemplateLink": {
           "uri": "https://raw.githubusercontent.com/kscherban/sapjira_qa_back/master/templates/app_gw.json"
          },
        "parameters": {
          "virtualNetworkName": {
            "value": "jvnet"
            },
          "vnetAddressPrefix": {
            "value": "10.0.0.0/16"
          },
          "subnetName": {
            "value": "subnet1"
          },
          "subnetPrefix": {
            "value": "10.0.1.0/24"
          },
          "applicationGatewayName": {
            "value": "jiraappgateway"
          },
          "applicationGatewaySize": {
            "value": "Standard_Small"
          },
          "applicationGatewayInstanceCount": {
            "value": 4
          },
          "frontendPort": {
            "value": 80
          },
          "backendPort": {
            "value": 80
          },
          "backendIPAddresses": {
            "value": [
              {
                "IpAddress": "10.0.0.4"
              },
              {
                "IpAddress": "10.0.0.5"
              }
            ]
          },
          "cookieBasedAffinity": {
            "value": "Disabled"
          },
          "location": {
            "defaultValue": "[resourceGroup().location]"
          }
        }
      } 
    }
   ],
    "outputs": {  }
  }